{% extends "base.html" %}

{% block content %}
<article class="post-detail">
    <header class="post-header">
        <h1 class="post-detail-title">{{ post.title }}</h1>

        <div class="post-detail-meta">
            <a href="{{ url_for('user_profile', username=post.author.username) }}" class="author-info">
                <div class="avatar">{{ post.author.username[0].upper() }}</div>
                <div class="author-details">
                    <span class="author-name">{{ post.author.username }}</span>
                    <span class="post-info">
                        <time>{{ post.date_posted.strftime('%d %B %Y') }}</time>
                        {% if post.category %}
                        · <a href="{{ url_for('category_posts', category_id=post.category.id) }}"
                            class="category-link">{{ post.category.name }}</a>
                        {% endif %}
                    </span>
                </div>
            </a>

            {% if current_user.is_authenticated and current_user == post.author %}
            <div class="post-actions">
                <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn btn-outline btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                    </svg>
                    Düzenle
                </a>
                <form action="{{ url_for('delete_post', post_id=post.id) }}" method="POST" class="inline-form"
                    onsubmit="return confirm('Bu yazıyı silmek istediğinizden emin misiniz?')">
                    <button type="submit" class="btn btn-danger btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                            </path>
                        </svg>
                        Sil
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </header>

    <div class="post-content">
        {{ post.content | safe }}
    </div>

    <footer class="post-detail-footer">
        <div class="engagement-bar">
            {% if current_user.is_authenticated %}
            <button class="like-btn {% if current_user.has_liked_post(post) %}liked{% endif %}"
                data-post-id="{{ post.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                    fill="{% if current_user.has_liked_post(post) %}currentColor{% else %}none{% endif %}"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                    </path>
                </svg>
                <span class="like-count">{{ post.like_count }}</span>
            </button>
            {% else %}
            <a href="{{ url_for('login') }}" class="like-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                    </path>
                </svg>
                <span class="like-count">{{ post.like_count }}</span>
            </a>
            {% endif %}

            <span class="comment-count">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                {{ post.comment_count }}
            </span>
        </div>
    </footer>
</article>

<!-- Yorumlar Bölümü -->
<section class="comments-section">
    <h2 class="comments-title">
        Yorumlar
        <span class="comments-count">({{ post.comment_count }})</span>
    </h2>

    {% if post.allow_comments %}
    {% if current_user.is_authenticated %}
    <form action="{{ url_for('add_comment', post_id=post.id) }}" method="POST" class="comment-form">
        {{ form.hidden_tag() }}
        <div class="form-group">
            <div class="comment-input-wrapper">
                <div class="avatar avatar-sm">{{ current_user.username[0].upper() }}</div>
                {{ form.body(class="form-input comment-input", placeholder="Düşüncelerinizi paylaşın...", rows=3) }}
            </div>
            {% if form.body.errors %}
            {% for error in form.body.errors %}
            <span class="form-error">{{ error }}</span>
            {% endfor %}
            {% endif %}
        </div>
        <div class="comment-form-actions">
            <button type="submit" class="btn btn-primary">Yorum Yap</button>
        </div>
    </form>
    {% else %}
    <div class="comment-login-prompt">
        <p>Yorum yapmak için <a href="{{ url_for('login') }}">giriş yapın</a>.</p>
    </div>
    {% endif %}
    {% else %}
    <div class="comments-disabled">
        <p>Bu yazıya yorum yapılamaz.</p>
    </div>
    {% endif %}

    <!-- Yorum Listesi -->
    <div class="comments-list">
        {% for comment in comments %}
        <div class="comment">
            <div class="comment-header">
                <a href="{{ url_for('user_profile', username=comment.author.username) }}" class="comment-author">
                    <div class="avatar avatar-sm">{{ comment.author.username[0].upper() }}</div>
                    <span class="comment-author-name">{{ comment.author.username }}</span>
                </a>
                <time class="comment-date">{{ comment.date_posted.strftime('%d %b %Y, %H:%M') }}</time>
            </div>
            <div class="comment-body">
                {{ comment.body }}
            </div>
            {% if current_user.is_authenticated and (current_user == comment.author or current_user == post.author) %}
            <div class="comment-actions">
                <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST" class="inline-form"
                    onsubmit="return confirm('Bu yorumu silmek istediğinizden emin misiniz?')">
                    <button type="submit" class="btn-link btn-danger-text">Sil</button>
                </form>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="no-comments">
            <p>Henüz yorum yapılmamış. İlk yorumu siz yapın!</p>
        </div>
        {% endfor %}
    </div>
</section>
{% endblock %}